太好了。我给你一份“**不漏不缺的实现任务清单 + 步骤化执行手册**”。每一步都包含：**目标、输入、具体操作、产出物、验收标准（DoD）**，按顺序完成即可把整套“视觉=趋势/形状、因果=扰动/高频、加性融合”的方案落地。

------

# 0. 准备阶段（1天）

**目标**：定规则、定目录、定记录方式，避免后期返工。
 **输入**：无。
 **步骤**
 0.1 建目录

```
data/raw/        # 原始CSV
data/processed/  # npz（train/val/test）
conf/            # yaml配置
src/             # 代码（后续实现）
logs/            # 训练日志、图表
artifacts/       # ckpt、A矩阵、可解释可视化
docs/            # 实验登记&报告
```

0.2 固化规范

- 统一随机种子；记录 Python/包版本。
- **防泄漏规则**：任何“可视化渲染/归一化/阈值/缩放”仅用 **train** 统计；**未来区域一律遮罩**。
- 统一指标：MSE、MAE、RMSE、MAPE、SMAPE、MASE；**按步长 h** 输出曲线。
   0.3 建“实验登记模板”（CSV/Markdown）：数据集名、L/H、batch、学习率、损失、最佳指标、图链路。
   **产出物**：`docs/实验操作手册.md`、`docs/实验登记模板.csv`
   **DoD**：任何人仅靠文档能重复“数据导入→切分→评测”流程。

------

# 1. 数据与切分（2天）

**目标**：打通 CSV→时间排序→缺失处理→标准化→滑窗→npz 的闭环。
 **输入**：ETT(ETTh1/ETTm1)、Electricity、Weather、Traffic（至少3个）。
 **步骤**
 1.1 时间解析 & 升序排序；可选重采样（统一频率）。
 1.2 缺失：线性插值→前后填充（记录缺失mask）。
 1.3 标准化：**逐变量 z-score（仅train统计）**，保存 `mean,std`。
 1.4 切分：`train/val/test = 0.7/0.1/0.2`（严格按时间）。
 1.5 滑窗生成：设定 `L（输入窗口）`、`H（预测步长）`、`stride=1`；输出

- `X:[N,L,D]`，`Y:[N,H,D]`；同时记录时间戳、target_index。
   **产出物**：
- `data/processed/{dataset}_L{L}_H{H}.npz`（含 X/Y/ts/scaler/mask）
   **DoD**：随机抽样10条绘制“历史→未来”曲线，形状/时间对齐；样本统计（N,L,H,D）正确。

------

# 2. 趋势-残差打标（2天）

**目标**：为“视觉学趋势T、因果学残差R”创建监督信号。
 **输入**：第1步 npz。
 **步骤**
 2.1 选择趋势分解：**移动平均（MA）**优先（窗口=与季节/日周期对齐，如24或96）；备选 STL、HP。
 2.2 计算：每条目标序列 `T = smooth(y)`；`R = y - T`。

- 严禁任何“未来窗”信息（MA 用**仅历史**可用窗）。
   2.3 将 `T, R` 追加到 npz。
   **产出物**：`data/processed/..._with_TR.npz`（含 X/Y/T/R）。
   **DoD**：抽样20条画 `y/T/R`；T 低频、R 高频（对比STFT能量或方差比例）。

------

# 3. 视觉路径（趋势/形状的 MVP）（3–5天）

**目标**：仅用历史渲染→ViT→回归 **T**（而不是 y）。
 **输入**：含 `T` 的 npz。
 **步骤**
 3.1 **图像渲染**（历史区）：

- 主通道：折线图（未来区域纯遮罩，**y轴缩放用历史**min/max或z-score范围）。
- 可选并行通道：GAF、STFT 频谱；组合成3通道（line/GAF/STFT）。分辨率统一 `224×224`。
   3.2 **模型设定**：ViT-B/16 主干**冻结**（先），MLP Head 输出 `[H,1]`，回归 **T**。
   3.3 **损失**：
   [
   \mathcal{L}*{vis}= \text{MSE}(\hat{T},T) + \lambda*{\nabla},\text{MSE}(\nabla\hat{T},\nabla T)
   ]
   （梯度一致项让峰谷位置更贴合，缓解过平滑与相位滞后）
   3.4 训练：混精度、Cosine LR、早停看 `val_MASE on T`。
   **产出物**：视觉模型ckpt、`artifacts/vis_attn_plots/`（注意力热力图抽样10例）、`plots/T_pred_vs_T_true`。
   **DoD**：在 ≥2 个数据集上，`T` 的 MSE 明显低于朴素 MA 基线；注意力落在峰谷/转折附近。

------

# 4. 因果路径（高频/扰动的 MVP）（4–6天）

**目标**：可学习图 A + TCN/GAT 学 **R**（残差/高频）。
 **输入**：含 `R` 的 npz。
 **步骤**
 4.1 **可学习邻接矩阵 A**：参数 `S∈R^{D×D}` → 行 softmax 得 `A`；L1 稀疏正则（`λ_A`）。
 （可选：先验掩码/禁止自环/禁止明显不合理边）
 4.2 **主干结构**：

- 时间维：TCN（膨胀卷积、残差、LN/BN）；
- 变量维：GraphBlock（GAT 或 A 加权线性混合）；**交替或并联**堆叠若干层；
- 头部：多步直接预测 DMS，输出 `[H,D]`（最终取 target_index）。
   4.3 **损失**：
   [
   \mathcal{L}_{cau}= \text{Huber}(\hat{R},R) + \lambda_A|A|_1
   ]
   （Huber 抗尖峰，L1 保稀疏、防伪相关）
   4.4 训练：监控 `||A||_0`/稀疏度、top-k 边。
   **产出物**：因果模型ckpt、`artifacts/A_matrix.npy`、`plots/R_pred_vs_R_true`。
   **DoD**：在 ≥2 数据集的**高频带**（用STFT带通度量）上，`R` 预测误差优于 TCN/Transformer 基线；A 的 top-k 边与常识相符且稀疏。

------

# 5. 加性融合与校准（2–3天）

**目标**：组装最终预测 `y_hat = T_hat + R_hat`，并做轻量校准降低偏差。
 **输入**：步骤3/4的预测。
 **步骤**
 5.1 **加性融合**：逐样本逐步长相加：(\hat{y}=\hat{T}+\hat{R})。
 5.2 **校准（仅 val 拟合）**：(\tilde{y}=a\hat{y}+b)，对齐均值/方差，降低 MAPE/SMAPE。
 5.3 **测试评估**：严禁用 test 做任何拟合。
 **产出物**：融合预测、`artifacts/calibration.json(a,b)`、`plots/yhat_vs_y`。
 **DoD**：在 ≥2 数据集、≥2 个 H 上，融合模型**全指标**优于两条单路径；步长曲线显示短步长更受视觉贡献、长步长因果补偿明显。

------

# 6. 自适应残差门控 或 不确定性加权（3–5天，二选一先做）

**目标**：应对复杂场景（分布漂移/缺测）提升鲁棒性。
 **输入**：步骤5的融合结果与上下文统计。
 **方案A 门控残差**
 6A.1 构造上下文特征：窗口波动率、季节性强度（自相关/周期功率）、缺测率、步长 h、最近 val 误差。
 6A.2 训练门控 MLP（仅在 val）：(\gamma=\sigma(\text{MLP}(ctx)))，(\hat{y}=\hat{T}+\gamma\hat{R})。
 **方案B 不确定性加权**
 6B.1 两路径各输出 ((\mu, \log\sigma^2))，训练异方差NLL；
 6B.2 融合：(\hat{y}=(\mu_v/\sigma_v^2 + \mu_c/\sigma_c^2)/(1/\sigma_v^2 + 1/\sigma_c^2))。
 **产出物**：门控/不确权参数、`plots/robustness_shift_missing`。
 **DoD**：在“遮蔽10%/跨域迁移”等设定下，鲁棒性指标优于基础加性融合；门控权重与直觉一致（高波动→γ↑，强季节→γ↓）。

------

# 7. 基线对比与消融（5–7天）

**目标**：证明“互补性”与设计必要性。
 **输入**：全链路。
 **步骤**
 7.1 **基线**：季节ETS、ARIMA/VAR；深度：TCN、N-BEATS、PatchTST / iTransformer、Graph WaveNet/MTGNN。
 7.2 **消融矩阵**：

- 仅视觉 / 仅因果 / 加性 / 加性+门控（或不确权）
- 渲染：line vs line+GAF vs line+GAF+STFT
- A正则：无 / L1 / L1+先验掩码
- 趋势分解：MA vs STL vs HP
   7.3 **报告**：主表（多数据集×多步长）、步长曲线、频带误差堆叠图、事件日案例。
   **产出物**：`docs/results_tables.xlsx`、所有图表。
   **DoD**：融合在多数格点优于强基线；结论与动机一致且稳定。

------

# 8. 可解释性与合规检查（2–3天）

**目标**：可讲清、可展示、无泄漏。
 **输入**：模型与中间件。
 **步骤**
 8.1 ViT注意力热力图：峰谷/转折关注分布；选10例。
 8.2 A矩阵：top-k可视化、度分布、与业务先验一致度。
 8.3 频带误差：小波或STFT分带，显示“低频视觉承担/高频因果承担”。
 8.4 泄漏核对清单：渲染范围、轴缩放、校准仅用 val。
 **产出物**：`artifacts/explainability/` 图集、`docs/leakage_checklist.md`。
 **DoD**：解释图能自洽；泄漏项逐条勾选通过。

------

# 9. 复现与交付（2–3天）

**目标**：一键复现、结果可审查。
 **输入**：完整工程。
 **步骤**
 9.1 固化所有 conf（yaml）：数据路径、L/H/stride、模型宽度、正则系数。
 9.2 打包 artifacts：scaler.json、A.npy、ckpt.pt、fusion/门控/校准参数、全量图表与指标表。
 9.3 完整“复现实验册”：每一步输入→输出→指令→产物路径。
 **产出物**：`docs/repro_guide.md`、`artifacts/release/`。
 **DoD**：新环境仅凭文档可跑完三数据集的主实验并复现主要结论。

------

## 关键默认配置（可直接写进 conf）

- `L=96, H=24/48/96, stride=1`
- 视觉：224×224，patch=16，头部LR=3e-4（冻结主干），解冻微调LR=1e-5，λ_∇=0.1
- 因果：d_model=128，TCN层=4（膨胀1,2,4,8），Graph头=4，λ_A=1e-3
- 优化：AdamW，wd=1e-4，cosine + warmup 5%
- 校准：线性仿射 a,b（val上拟合）

------

## 常见风险与应对

- **视觉过平滑/相位滞后** → 提高 λ_∇、增大 L、加季节位置编码；补充 STFT通道。
- **A 过密/伪相关** → 提高 λ_A、top-k 截断、加入先验掩码（业务不可能边置0）。
- **融合不稳** → 启用门控/不确权；对极端日用 Huber/分位点指标观察。
- **泄漏嫌疑** → 复核渲染与缩放是否只用历史统计；校准是否仅 val。

------

### 最小可交付里程碑（建议四周）

- **周1**：步骤0–2完成；产出 `y/T/R` 样例与质量报告
- **周2**：步骤3–4完成；两条路径各自优于对应基线
- **周3**：步骤5–6完成；融合在≥2数据集多数步长显著优于基线
- **周4**：步骤7–9完成；消融/解释/复现资料齐全

------

这套清单按顺序执行就能把你的方案稳定做完，且材料齐全、方便写论文和答辩。如果你希望，我可以把这份计划再精简为一张**甘特图样式的里程碑清单**或一页纸**检查表**，你团队直接照单执行。









