# ViTSF: A Two-Path Framework for Time Series Forecasting

本仓库实现了一个创新的**双路径**时间序列预测框架（ViTSF），其核心思想是**将时间序列的“形状”预测与“值”预测分离**，通过两条并行的路径分别建模，最后融合信息以提升预测精度。

## 算法思路

传统模型通常试图在一个单一模型中同时学习时间序列的复杂模式（形状）和数值大小（值），这可能导致顾此失彼。本项目将该问题分解为两个更专注的子任务，并通过双路径架构解决。

### 1. 双路径架构：形状与值的分离

我们的框架包含两条核心路径：

- **ViT 路径 (Shape Modeling)**：专注于学习和预测时间序列曲线的**形状**或**模式**。
- **因果路径 (Value Modeling)**：专注于预测目标变量的**绝对值**或**量级**。

通过这种方式，模型可以更精准地捕捉不同层面的信息，避免单一模型在复杂任务下的学习混淆。

### 2. Path 1: 使用 Vision Transformer (ViT) 进行形状建模

此路径的目标是理解序列的动态模式，而不受其绝对数值大小的干扰。

- **输入**：通常是经过**标准化**或**趋势-残差分解**后的序列。这有助于模型专注于捕捉周期性、季节性等与“形状”相关的特征。
- **ViT 模型**：我们将 Vision Transformer 的思想迁移至时序预测：
    - **序列作图**：将一维时间序列窗口视为一个“1D 图像”。
    - **分块 (Patching)**：将输入窗口切分成若干不重叠的“块”(Patch)。
    - **特征嵌入**：将每个块线性映射为特征向量 (Token)，并加入位置编码。
    - **Transformer 编码器**：利用自注意力机制捕捉序列的长期依赖和全局模式。
- **输出**：此路径输出的是关于序列未来“形状”的表征。

### 3. Path 2: 使用因果模型进行值建模

此路径的目标是精准预测目标变量的**数值**。

- **思路**：采用**多变量预测单变量**的策略。它利用所有可用的相关变量（多变量输入）来预测目标变量的未来值。
- **因果性**：模型设计确保在预测 `t` 时刻的值时，只使用 `t` 时刻及之前的历史信息，保证无未来数据泄漏。
- **输出**：此路径输出对目标变量未来**绝对值**的直接预测。

### 4. 信息融合

最后，我们将两条路径的输出进行有效融合，以产生最终的预测结果。

- **融合层**：通过一个简单的**线性层**或其他可学习的模块，将“形状”路径的模式表征与“值”路径的数值预测相结合。
- **最终预测**：融合后的信息能够同时兼顾序列的宏观模式和精确的数值量级，从而实现比单一路径更准确的预测。

## 数据处理流程

为了支撑上述双路径模型，数据处理流程至关重要：

1.  **原始数据预处理 (`preprocess.py`)**:
    - 读取原始 CSV 文件，处理缺失值。
    - **标准化**：**仅使用训练集**的均值和标准差来标准化整个数据集，为“形状”建模提供纯净的模式输入。
    - 将处理好的数据保存为 `.npz` 格式。

2.  **趋势-残差标签生成 (`make_tr_labels.py`)**:
    - （可选但推荐）此脚本可将标准化后的序列进一步分解为**趋势 (T)** 和**残差 (R)** 分量。
    - 这些分解后的分量可以作为“形状”路径的更优输入，让 ViT 更专注于学习特定模式。
    - 分解过程同样遵循**因果**原则，通过在完整拼接的序列上计算，避免了边界效应。

3.  **构建 PyTorch 数据集 (`dataset.py`)**:
    - `SlidingWindowDataset` 类负责从处理好的 `.npz` 文件中，根据指定的输入长度和预测范围，生成滑动窗口样本，供双路径模型训练。

## 如何运行

1.  **下载数据集**
    ```bash
    python scripts/download_datasets.py
    ```

2.  **预处理数据**
    ```bash
    # 以 ETT 数据集为例
    python src/data/preprocess.py ett
    ```

3.  **（可选）生成趋势-残差标签**
    ```bash
    python src/data/make_tr_labels.py --npz data/processed/ett/ETTh1/data.npz
    ```

4.  **训练模型**
    ```bash
    # (待补充)
    # python train.py --config configs/vit_dual_path_ett.yaml
    ```

